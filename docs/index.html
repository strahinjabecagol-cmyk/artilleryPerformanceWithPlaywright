<!DOCTYPE html>
<html lang="en">

<head>
  <!-- ⚠️ CACHE BUSTING: The meta tags below prevent browser from caching old data -->
  <meta charset="UTF-8" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>Artillery Performance Report</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
  <link rel="stylesheet" href="dashboard.css">
</head>

<body>

  <body>
    <div class="container">
      <header>
        <div class="data-info">
          <span class="status"></span>
          <span id="lastUpdated">Loading...</span>
        </div>
        <div class="export-buttons">
          <button class="export-btn" onclick="openJSONPreview()" title="Preview results.json in browser">
            👁️ Preview JSON
          </button>
          <button class="export-btn" onclick="openLogPreview()" title="View execution log">
            📋 View Log
          </button>
          <button class="export-btn" onclick="exportToPNG()" title="Export dashboard as PNG image">
            📸 Export PNG
          </button>
          <button class="export-btn" onclick="downloadJSON()" title="Download results.json file">
            💾 Download JSON
          </button>
        </div>
        <h1>🪖 Artillery Performance Dashboard 🪖</h1>
        <div class="subtitle">Performance metrics and analysis</div>
      </header>

      <!-- Test Metadata -->
      <div class="test-metadata" id="testMetadata">
        <div class="metadata-item">
          <div class="metadata-label">Test Name</div>
          <div class="metadata-value" id="testName">Loading...</div>
        </div>
        <div class="metadata-item">
          <div class="metadata-label">Target URL</div>
          <div class="metadata-value" id="targetUrl">Loading...</div>
        </div>
        <div class="metadata-item">
          <div class="metadata-label">Test Duration</div>
          <div class="metadata-value" id="testDuration">Loading...</div>
        </div>
        <div class="metadata-item">
          <div class="metadata-label">Start Time</div>
          <div class="metadata-value" id="startTime">Loading...</div>
        </div>
        <div class="metadata-item">
          <div class="metadata-label">Scenarios</div>
          <div class="metadata-value" id="scenarioCount">Loading...</div>
        </div>
        <div class="metadata-item">
          <div class="metadata-label">Total Periods</div>
          <div class="metadata-value" id="periodCount">Loading...</div>
        </div>
      </div>

      <!-- Summary Metrics -->
      <div class="metrics" id="summary"></div>

      <!-- Core Web Vitals Section -->
      <div class="section-title">⚡ Core Web Vitals</div>
      <div class="vitals-grid" id="vitals"></div>

      <!-- Performance Charts -->
      <div class="section-title">📈 Performance Trends</div>
      <div class="charts-container">
        <div class="chart-wrapper compact">
          <h2>📊 Throughput (RPS) <span class="tooltip"
              data-tooltip="Requests Per Second processed over time. Shows system capacity and identifies performance bottlenecks. Sudden dips indicate potential issues.">?</span>
          </h2>
          <div class="chart-desc">HTTP requests processed per second during each test period</div>
          <canvas id="throughputChart"></canvas>
        </div>
        <div class="chart-wrapper compact">
          <h2>🎨 First Contentful Paint <span class="tooltip"
              data-tooltip="Shows how FCP (time to first visible content) changed across different test periods. Lower values indicate faster perceived load times.">?</span>
          </h2>
          <div class="chart-desc">Average time for first content to appear on screen during each test period</div>
          <canvas id="latencyChart"></canvas>
        </div>
      </div>

      <div class="charts-container">
        <div class="chart-wrapper compact">
          <h2>👥 Virtual Users Activity <span class="tooltip"
              data-tooltip="Number of simulated users that successfully completed the test scenario in each period. Drops may indicate capacity issues.">?</span>
          </h2>
          <div class="chart-desc">VUsers successfully completed per test period</div>
          <canvas id="rpsChart"></canvas>
        </div>
        <div class="chart-wrapper compact">
          <h2>👤 Concurrent Users Over Time <span class="tooltip"
              data-tooltip="Number of virtual users actively running at any given moment. Calculated as: Created - (Completed + Failed). Shows actual load on the system.">?</span>
          </h2>
          <div class="chart-desc">Active VUsers running simultaneously during the test</div>
          <canvas id="concurrentUsersChart"></canvas>
        </div>
      </div>

      <div class="charts-container">
        <div class="chart-wrapper compact">
          <h2>📊 HTTP Requests <span class="tooltip"
              data-tooltip="Total HTTP requests made during each period. Includes all page loads, API calls, and resource fetches.">?</span>
          </h2>
          <div class="chart-desc">Total HTTP requests per test period</div>
          <canvas id="httpRequestsChart"></canvas>
        </div>
        <div class="chart-wrapper compact">
          <h2>📊 Combined Performance Metrics <span class="tooltip"
              data-tooltip="Combined view of RPS, Response Time, and FCP over time. Shows the relationship between load, latency, and user experience metrics.">?</span>
          </h2>
          <div class="chart-desc">RPS, Response Time, and FCP trends in one view</div>
          <canvas id="combinedMetricsChart"></canvas>
        </div>
      </div>

      <!-- Advanced Analysis -->
      <div class="section-title">📊 Advanced Analysis</div>
      <div class="charts-container">
        <div class="chart-wrapper compact-tall">
          <h2>⏱️ Response Time Percentiles <span class="tooltip"
              data-tooltip="Distribution of FCP times. p95 means 95% of users experienced this time or better. Higher percentiles show worst-case scenarios.">?</span>
          </h2>
          <div class="chart-desc">FCP performance distribution - p50 (median) to p99 (worst case)</div>
          <canvas id="percentilesChart"></canvas>
        </div>
        <div class="chart-wrapper compact-tall">
          <h2>✅ Success vs Failure Rate <span class="tooltip"
              data-tooltip="Overall test reliability. Shows percentage of users who completed successfully vs those who encountered errors.">?</span>
          </h2>
          <div class="chart-desc">Overall test completion rate - target >95% success for production readiness</div>
          <canvas id="successChart"></canvas>
        </div>
      </div>

      <div class="charts-container">
        <div class="chart-wrapper compact-tall">
          <h2>🌐 HTTP Status Codes <span class="tooltip"
              data-tooltip="Breakdown of HTTP response codes. 200=Success, 204=No Content, 500=Server Error. High error rates indicate server issues.">?</span>
          </h2>
          <div class="chart-desc">Distribution of server response codes during the test</div>
          <canvas id="statusCodesChart"></canvas>
        </div>
        <div class="chart-wrapper compact-tall">
          <h2>📈 Latency Distribution <span class="tooltip"
              data-tooltip="Response time distribution grouped in 100ms buckets. Shows how many requests fall into each latency range. Green=fast, Orange=moderate, Red=slow.">?</span>
          </h2>
          <div class="chart-desc">Response time histogram grouped by 100ms intervals</div>
          <canvas id="latencyHistogram"></canvas>
        </div>
      </div>

      <div class="charts-container">
        <div class="chart-wrapper compact-tall">
          <h2>🚨 HTTP Error Breakdown <span class="tooltip"
              data-tooltip="Detailed breakdown of HTTP errors. 4xx errors are client-side issues (bad requests, not found, etc.). 5xx errors are server-side failures.">?</span>
          </h2>
          <div class="chart-desc">Client errors (4xx) vs Server errors (5xx)</div>
          <canvas id="errorBreakdown"></canvas>
        </div>
        <div class="chart-wrapper compact-tall">
          <h2>⚙️ Scenario Step Performance <span class="tooltip"
              data-tooltip="Average duration for each step in your test scenario. Identifies performance bottlenecks at the step level. Slowest step highlighted in red.">?</span>
          </h2>
          <div class="chart-desc">Average execution time per scenario step (slowest highlighted)</div>
          <canvas id="stepBreakdown"></canvas>
        </div>
      </div>
    </div>

    <!-- JSON Preview Modal -->
    <div class="json-modal" id="jsonModal">
      <div class="json-modal-content">
        <div class="json-modal-header">
          <div class="json-modal-title">
            <span>📄</span>
            <span>results.json</span>
            <span style="font-size: 0.75rem; color: #94a3b8; font-weight: 400;" id="jsonFileSize">Loading...</span>
          </div>
          <div class="json-modal-actions">
            <button class="json-action-btn copy" onclick="copyJSON()" title="Copy to clipboard">
              📋 Copy
            </button>
            <button class="json-action-btn" onclick="downloadJSON()" title="Download file">
              💾 Download
            </button>
            <button class="json-action-btn close" onclick="closeJSONPreview()" title="Close preview">
              ✕ Close
            </button>
          </div>
        </div>
        <div class="json-search-bar">
          <input type="text" class="json-search-input" id="jsonSearch"
            placeholder="🔍 Search in JSON... (e.g., 'vusers', 'FCP', 'mean')" onkeyup="searchJSON()" />
        </div>
        <div class="json-modal-body">
          <div class="json-content" id="jsonContent">Loading JSON data...</div>
        </div>
      </div>
    </div>

    <!-- Execution Log Modal -->
    <div class="json-modal" id="logModal">
      <div class="json-modal-content">
        <div class="json-modal-header">
          <div class="json-modal-title">
            <span>📋</span>
            <span>execution.log</span>
            <span style="font-size: 0.75rem; color: #94a3b8; font-weight: 400;" id="logFileSize">Loading...</span>
          </div>
          <div class="json-modal-actions">
            <button class="json-action-btn copy" onclick="copyLog()" title="Copy to clipboard">
              📋 Copy
            </button>
            <button class="json-action-btn" onclick="downloadLog()" title="Download file">
              💾 Download
            </button>
            <button class="json-action-btn close" onclick="closeLogPreview()" title="Close preview">
              ✕ Close
            </button>
          </div>
        </div>
        <div class="json-search-bar">
          <input type="text" class="json-search-input" id="logSearch"
            placeholder="🔍 Search in log... (e.g., 'error', 'completed', 'p95')" onkeyup="searchLog()" />
        </div>
        <div class="json-modal-body">
          <pre class="json-content" id="logContent"
            style="white-space: pre-wrap; font-family: 'Courier New', monospace;">Loading log data...</pre>
        </div>
      </div>
    </div>

    <script src="dashboard.js" type="module"></script>
  </body>

</html>